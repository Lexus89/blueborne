<!DOCTYPE html>
<!-- saved from url=(0051)http://sploit3r.xyz/blueborne-exploitation-nexus-4/ -->
<html lang="en-US" class="" slick-uniqueid="3"><head class="no-js"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="profile" href="http://gmpg.org/xfn/11">
	        <link rel="pingback" href="http://sploit3r.xyz/xmlrpc.php">
	    <script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
<title>BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r</title>
<link rel="dns-prefetch" href="http://sploit3r.xyz/">
<link rel="dns-prefetch" href="http://fonts.googleapis.com/">
<link rel="dns-prefetch" href="http://s.w.org/">
<link rel="alternate" type="application/rss+xml" title="Sploit3r ¬ª Feed" href="http://sploit3r.xyz/feed/">
<link rel="alternate" type="application/rss+xml" title="Sploit3r ¬ª Comments Feed" href="http://sploit3r.xyz/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="Sploit3r ¬ª BlueBorne exploitation on Nexus 4 Comments Feed" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/feed/">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.4\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.4\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/sploit3r.xyz\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.6"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55357,56692,8205,9792,65039],[55357,56692,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script><script src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/wp-emoji-release.min.js.download" type="text/javascript" defer=""></script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel="stylesheet" id="contact-form-7-css" href="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/styles.css" type="text/css" media="all">
<link rel="stylesheet" id="wpstatistics-css-css" href="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/frontend.css" type="text/css" media="all">
<link rel="stylesheet" id="simplent-google-fonts-css" href="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/css" type="text/css" media="all">
<link rel="stylesheet" id="bootstrap-css" href="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/bootstrap.min.css" type="text/css" media="all">
<link rel="stylesheet" id="font-awesome-css" href="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/font-awesome.min.css" type="text/css" media="all">
<link rel="stylesheet" id="simplent-style-css" href="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/style.css" type="text/css" media="all">
<link rel="stylesheet" id="enlighter-local-css" href="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/EnlighterJS.min.css" type="text/css" media="all">
<script type="text/javascript" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/jquery.js.download"></script>
<script type="text/javascript" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/jquery-migrate.min.js.download"></script>
<link rel="https://api.w.org/" href="http://sploit3r.xyz/wp-json/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://sploit3r.xyz/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://sploit3r.xyz/wp-includes/wlwmanifest.xml"> 
<link rel="next" title="CVE-2017-13284 : Injection in configuration file" href="http://sploit3r.xyz/cve-2017-13284-injection-in-configuration-file/">
<meta name="generator" content="WordPress 4.9.6">
<link rel="canonical" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/">
<link rel="shortlink" href="http://sploit3r.xyz/?p=4">
<link rel="alternate" type="application/json+oembed" href="http://sploit3r.xyz/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fsploit3r.xyz%2Fblueborne-exploitation-nexus-4%2F">

<style id="fit-vids-style">.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}</style></head>
<body class="post-template-default single single-post postid-4 single-format-standard wp-custom-logo">
    <div class="search-popup">
        <span class="search-popup-close"><i class="fa fa-times"></i></span>
        
<form action="http://sploit3r.xyz/" method="get" role="search" id="searchform_topbar" class="search-top-bar-popup search-form">
	<label>
		<span class="screen-reader-text">Search for:</span>
		<input type="search" class="search-field-top-bar" id="search-field-top-bar" placeholder="Search ‚Ä¶" value="" name="s">
	</label>
	<button type="submit" class="search-submit search-top-bar-submit" id="search-top-bar-submit">
        <span class="fa fa-search header-search-icon"></span>
        <span class="screen-reader-text">
            Search        </span>
    </button>
</form>
    </div><!-- .search-popup -->

<div id="page" class="site">
    <div class="site-inner">
        <a class="skip-link screen-reader-text" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/#content">Skip to content</a>

        <header id="masthead" class="site-header" role="banner">

                    <div class="container">
                <div class="header-links">
                                            <span class="btn-search fa fa-search icon-button-search"></span>
                    	                                </div><!-- .header-link -->
            </div>
        
        <div class="site-header-main">
            <div class="site-branding">
                <a href="http://sploit3r.xyz/" class="custom-logo-link" rel="home" itemprop="url"><img width="180" height="180" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/if_Rudolf_Deer_1651925-e1518118057940.png" class="custom-logo" alt="Sploit3r" itemprop="logo"></a>                    <p class="site-title">
                        <a href="http://sploit3r.xyz/" rel="home">
                            Sploit3r                        </a>
                    </p>
                
            </div><!-- .site-branding -->

            
        </div><!-- .site-header-main -->


    
</header>

        <div id="content" class="site-content container">

	<div id="primary" class="content-area row">
		<main id="main" class="site-main col-md-8 col-sm-12" role="main">

			
<article id="post-4" class="post-4 post type-post status-publish format-standard hentry category-android tag-android tag-blueborne tag-bluetooth tag-exploit">

	<header class="entry-header">
		<h1 class="entry-title">BlueBorne exploitation on Nexus 4</h1>
		<div class="entry-info">
			<span class="posted-on">Posted on <time class="entry-date published" datetime="2018-02-08T12:54:03+00:00">February 8, 2018</time><time class="updated" datetime="2018-05-04T10:39:15+00:00">May 4, 2018</time></span><span class="author-info"> by <a href="http://sploit3r.xyz/author/sploit3r/">sploit3r</a></span>		</div>
	</header>

	
	<div class="entry-content">
		<h1 style="text-align: justify;">Introduction</h1>
<p style="text-align: left;">In September 2017, Armis security researchers have published a whitepaper named ‚Äú<a href="https://www.armis.com/blueborne/">BlueBorne</a>‚Äù which reveals several vulnerabilities in different bluetooth stack implementations. All major stacks are impacted and for Android system (Bluedroid), three vulnerabilities have been discovered :</p>
<p style="font-weight: 400; text-align: left;"><strong>CVE-2017-0785</strong>&nbsp;<strong>:</strong>&nbsp;Memory leak<strong><br>
CVE-2017-0781</strong>&nbsp;and<strong>&nbsp;CVE-2017-0782</strong>&nbsp;: Buffer overflow which can lead to remote execution</p>
<p style="font-weight: 400;">To demonstrate the vulnerability, Armis team developed a proof of concept and exploited the CVE-2017-0781 vulnerability on Android 7.1. <a href="https://github.com/ArmisSecurity/blueborne">https://github.com/ArmisSecurity/blueborne</a></p>
<p style="text-align: left;">Last release version of Nexus 4 runs on <strong>Android 5.1.1</strong> and bluetooth implementation contains a lot a changes regarding Android 7.x. The main difference is the heap allocator which is totally different.</p>
<p>To exploit <strong>CVE-2017-0781&nbsp;</strong>on Nexus 4 device (latest software update) , a different exploit has been developed and is detailed in this blog post.</p>
<p style="text-align: left;">ALSR bypass was done using<strong>&nbsp;CVE-2017-0785</strong>&nbsp;but it is not explained here because there is no difference with Android 7.0</p>
<p>The android image used for this exploit is available here :<br>
<a href="https://developers.google.com/android/images#occam">https://developers.google.com/android/images#occam</a></p>
<table style="height: 15px;" width="679">
<tbody>
<tr>
<td>5.1.1 (LMY48T)</td>
<td><a href="https://dl.google.com/dl/android/aosp/occam-lmy48t-factory-c43c7cfd.zip">Link</a></td>
<td>c43c7cfd7e77ae97dad0c2e0f3810f84bc5e2ca3b4dc74256eb7e13012ec1131</td>
</tr>
</tbody>
</table>
<p><span id="more-4"></span></p>
<p><strong>DISCLAIMER&nbsp;: All the information provided here are for educational purposes only.&nbsp;Performing any hack attempts/tests without written permission from the owner of the targeted device is illegal.</strong></p>
<h2 style="text-align: justify;">Bluedroid differences between Android 5.x and 7.x</h2>
<h3 style="text-align: justify;"><strong>Android 7.x</strong></h3>
<p style="text-align: left;">In Android 7.x system, the vulnerability is located in file<code> bnep_main.c</code> and function <a href="https://android.googlesource.com/platform/system/bt/+/android-7.1.1_r44/stack/bnep/bnep_main.c#579"><em>bnep_data_ind</em></a></p>
<p style="text-align: justify;"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0.png" width="602" height="173"></p>
<p style="text-align: left;">Line <em>#578</em>, a <em>malloc</em> is performed with the function <code class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">osi_malloc(rem_len)</code><span class="enlighterEnlighterJS EnlighterJS"><span class="kw1">osi_malloc</span><span class="br0">(</span><span class="">rem_len</span><span class="br0">)</span></span><em>,</em> pointer returned is saved in&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">p_bcp-&gt;pending_data</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">p_bcp-&gt;pending_data</span></span>. Then, line #579 a&nbsp;<em>memcpy</em>&nbsp;in executed with&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">((UINT8 *)(p_bcb-&gt;p_pending_data +1)</code><span class="enlighterEnlighterJS EnlighterJS"><span class="br0">(</span><span class="br0">(</span><span class="">UINT8 *</span><span class="br0">)</span><span class="br0">(</span><span class="">p_bcb-&gt;p_pending_data +</span><span class="nu0">1</span><span class="br0">)</span></span>&nbsp; as source address.<br>
It can be noticed that 1 is added to <code class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">p_bcb-&gt;p_pending_data</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">p_bcb-&gt;p_pending_data</span></span> address. However&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">p_bcb-&gt;p_pending_data</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">p_bcb-&gt;p_pending_data</span></span>&nbsp;is a&nbsp;&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">BT_HDR*</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">BT_HDR*</span></span>&nbsp;&nbsp;pointer so ‚Äú+1‚Äù means&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">+&nbsp;sizeof(BT_HDR).</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">+ </span><span class="kw1">sizeof</span><span class="br0">(</span><span class="">BT_HDR</span><span class="br0">)</span><span class="">.</span></span> Finally the destination address is&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">(UINT8*)(p_bcb-&gt;p_pending_data) + 8</code><span class="enlighterEnlighterJS EnlighterJS"><span class="br0">(</span><span class="">UINT8*</span><span class="br0">)</span><span class="br0">(</span><span class="">p_bcb-&gt;p_pending_data</span><span class="br0">)</span><span class=""> + </span><span class="nu0">8</span></span>&nbsp;. Because the length of the copy is not adapted with this offset, there is a buffer overflow of 8 bytes after the allocated&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">p_bcb&gt;p_pending_data</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">p_bcb&gt;p_pending_data</span></span>buffer.</p>
<p style="text-align: left;">According to the Armis technical paper, this overflow is triggered for any chosen size.</p>
<p style="text-align: left;">‚ÄúNotably,‚Äã ‚Äã since‚Äã ‚Äã it‚Äôs‚Äã ‚Äã possible‚Äã ‚Äã to‚Äã ‚Äã send‚Äã ‚Äã an‚Äã ‚Äã arbitrarily‚Äã ‚Äã sized‚Äã ‚Äã packet,‚Äã ‚Äã the‚Äã ‚Äã <code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">osi_malloc</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">osi_malloc</span></span> ‚Äã ‚Äã allocation‚Äã ‚Äã size‚Äã ‚Äã can‚Äã ‚Äã be controlled,‚Äã ‚Äã since‚Äã ‚Äã <code class="EnlighterJSRAW" data-enlighter-language="generic" style="display: none;">rem_len</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">rem_len</span></span> ‚Äã ‚Äã represents‚Äã ‚Äã the‚Äã ‚Äã size‚Äã ‚Äã of‚Äã ‚Äã the‚Äã ‚Äã payload ‚Äã ‚Äã in‚Äã ‚Äã the‚Äã ‚Äã packet.‚Äã ‚Äã This‚Äã ‚Äã allows‚Äã ‚Äã an‚Äã ‚Äã overflow‚Äã ‚Äã of‚Äã ‚Äã 8 bytes‚Äã ‚Äã on‚Äã ‚Äã the‚Äã ‚Äã heap‚Äã ‚Äã following‚Äã ‚Äã a ‚Äã ‚Äã buffer‚Äã ‚Äã of‚Äã ‚Äã any‚Äã‚Äã ‚Äã chosen‚Äã ‚Äã size,‚Äã ‚Äã which‚Äã ‚Äã makes‚Äã ‚Äã exploitation‚Äã ‚Äã much‚Äã ‚Äã easier.‚Äù</p>
<p style="text-align: left;">Then the overflow is used to override data contained in another object.</p>
<p style="text-align: left;"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(1).png" width="602" height="103"></p>
<p style="text-align: left;">The function pointer &nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">((post_to_task_hack_t *) (&amp;p_mg-&gt;data[0]))-&gt;callback</code><span class="enlighterEnlighterJS EnlighterJS"><span class="br0">(</span><span class="br0">(</span><span class="">post_to_task_hack_t *</span><span class="br0">)</span><span class=""> </span><span class="br0">(</span><span class="">&amp;p_mg-&gt;data</span><span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="">-&gt;callback</span></span> and its parameter <code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">p_mgs</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">p_mgs</span></span> are user controlled from bluetooth packets. In their exploit, this was used to call system function of <code>libc.so</code> to finish the exploitation.</p>
<h3 style="text-align: justify;"><strong>Android 5.x</strong></h3>
<p>In this Android 5.x; the vulnerability is located in the same file and function.</p>
<p style="text-align: justify;"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(2).png" width="602" height="269"></p>
<p style="text-align: left;">In this version, it can be noticed that&nbsp;<strong>allocation function is different</strong>.<br>
In Android 5.x,&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">GKI_getbuf</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">GKI_getbuf</span></span>&nbsp;is called whereas it was&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">osi_malloc</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">osi_malloc</span></span>&nbsp;in Android 7.x</p>
<p style="text-align: left;">GKI allocation system is based on memory pools of different size (similar to SLAB allocator).<br>
When a buffer is requested, a memory ‚Äòchunk‚Äô is returned but internally its size can be greater than the requested length. The buffer overflow does not impact the same things than in version of Android 7.x which make Armis PoC not working in this case.</p>
<p style="text-align: left;">In addition, the&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">BTU_POST_TO_TASK_NO_GOOD_HORRIBLE_HACK</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">BTU_POST_TO_TASK_NO_GOOD_HORRIBLE_HACK</span></span>&nbsp;switch case is not present in the code and could not be used to gain control of the execution flow.</p>
<p style="text-align: left;">Modifications between both versions were noticed. A new way had to be found to exploit this vulnerability.</p>
<h2 style="text-align: justify;">Arbitrary write / GKI Heap allocator</h2>
<p style="text-align: left;">At Bluedroid start up, the GKI dynamic allocator is initialized. Memory pools are created and registered in a global variable named&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">gki_cb</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">gki_cb</span></span>.</p>
<p style="text-align: left;">A pool is a continuous memory with fixed chunk data size.</p>
<p style="text-align: justify;"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(3).png" width="602" height="167"></p>
<p style="text-align: left;">When an allocation is requested, pools are looped from 0 to 9. When the chunk data size of the pool is large enough for the requested size, the allocator returns the first free chunk.</p>
<p style="text-align: left;">Sizes of all pools can be found in<em>&nbsp;<code>/include/gki_target.h</code></em>&nbsp;file and can be summarized as following.</p>
<table>
<tbody>
<tr>
<td style="text-align: justify;">Pool ID</td>
<td style="text-align: left;">Pool Size</td>
</tr>
<tr>
<td>0</td>
<td>0x40</td>
</tr>
<tr>
<td>1</td>
<td>0x120</td>
</tr>
<tr>
<td>2</td>
<td>0x294</td>
</tr>
<tr>
<td>3</td>
<td>0x1010</td>
</tr>
<tr>
<td>4</td>
<td>0x1faa</td>
</tr>
<tr>
<td>5</td>
<td>0x2ec</td>
</tr>
<tr>
<td>6</td>
<td>0x10c</td>
</tr>
<tr>
<td>7</td>
<td>0x2818</td>
</tr>
<tr>
<td>8</td>
<td>0x80</td>
</tr>
<tr>
<td>9</td>
<td>0x2000</td>
</tr>
</tbody>
</table>
<p style="text-align: left;">Before each data chunk, a 8 bytes header contains information about the data. The first element (<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">p_next</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">p_next</span></span>), is a pointer to the next buffer in the queue. It is used to create a chained list of buffer.</p>
<p style="text-align: justify;"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(4).png" width="602" height="149"></p>
<p style="text-align: left;">In order to override data of the next chunk, size requested must be equal to the maximum size in the pool targeted. Up to 8 bytes can be overwritten which correspond to the header part.</p>
<p style="text-align: left;">In the diagrams below, the memory written by the <code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">memcpy</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">memcpy</span></span> call is represented in red :</p>
<p style="text-align: justify;"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(5).png" width="602" height="92"></p>
<p style="text-align: justify;"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(6).png" width="346" height="274"></p>
<p style="text-align: left;">States of each memory pools are managed by a <code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">struct&nbsp;FREE_QUEUE_T</code><span class="enlighterEnlighterJS EnlighterJS"><span class="kw1">struct</span><span class=""> FREE_QUEUE_T</span></span> which contains usage information about a pool. This structure counts the number of chunk used and has a pointer (<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">p_first</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">p_first</span></span>) to the next free element.</p>
<p style="text-align: left;">When an allocation is requested, <code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">GKI_getbuf</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">GKI_getbuf</span></span> function returns the&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">p_first</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">p_first</span></span>&nbsp;element and changes the value by the <em>p_next</em> pointer contained in the <code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">BUFFER_HDR_T</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">BUFFER_HDR_T</span></span><code>.</code></p>
<p style="text-align: justify;"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(7).png" width="602" height="409"></p>
<p style="text-align: left;">In order to write data at a controlled address, two allocations in a&nbsp;<strong>same pool</strong>&nbsp;are needed.</p>
<ul style="text-align: left;">
<li>A first one with a size equals to the maximum buffer size of the pool in order to override the p_next field of following&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">BUFFER_HDR_T</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">BUFFER_HDR_T</span></span>&nbsp;header. When the&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">FREE_QUEUE_T</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">FREE_QUEUE_T</span></span>&nbsp;structure of the corresponding pool is updated, the new value of&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">p_first</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">p_first</span></span>&nbsp;will be set with a controlled address.</li>
<li>A second allocation to write data at the address previously set.</li>
</ul>
<p style="text-align: left;">To control data written, the second allocation must be executed just after the first one. However the GKI allocator is used internally; when a bluetooth packet is received several&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">GKI_getbuf</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">GKI_getbuf</span></span>/<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">GKI_free</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">GKI_free</span></span>&nbsp;calls are executed.</p>
<p style="text-align: left;">The pool ID 0 with a chunk size of 0x40 contains smaller objects and cannot be used because several objects are allocated in this pool when a packet is received.</p>
<p style="text-align: left;">The pool ID 1 Ôøº(size 0x120) is the best candidate. By tracing the execution of GKI allocator, it has been noticed that for a packet size of 0x120, only one allocation is done.</p>
<p style="text-align: left;">This allocation is done by the code previously seen with&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">GKI_getbuf</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">GKI_getbuf</span></span>. A good point is that this buffer is then filled with incoming packet data.</p>
<p style="text-align: justify;"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(2).png" width="602" height="269"></p>
<p style="text-align: left;">At this point we are able to perform an arbitrary write with controlled data using the pool ID 1.</p>
<p style="text-align: left;">Let‚Äôs sum up the arbitrary write :</p>
<p style="text-align: left;"><strong>Step 1 :&nbsp;</strong>Send a packet with a size of 0x120 bytes. At the end of payload data, write the&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">BUFFER_HDR</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">BUFFER_HDR</span></span>&nbsp;structure to set the following&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">p_next</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">p_next</span></span>&nbsp;with an arbitrary address.<br>
<strong><br>
Step 2 :</strong>&nbsp;Send a packet with a payload size between 0x40 and 0x120.</p>
<h2 style="text-align: justify;">Control execution / GKI mail box system</h2>
<p style="text-align: left;">By analysing the main loop (<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">btu_task</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">btu_task</span></span><em><code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;"></code><span class="enlighterEnlighterJS EnlighterJS"></span></em>&nbsp;function of&nbsp;<code>btu_task.c</code>&nbsp;file) which processes incoming packets we can understand the following workflow :</p>
<ol>
<li style="text-align: left;">Wait for a new event by calling the blocking function <code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">GKI_wait</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">GKI_wait</span></span></li>
<li style="text-align: left;">Get new mbox message of&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">BTU_HCI_RCV_MBOX</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">BTU_HCI_RCV_MBOX</span></span>&nbsp;queue with&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">GKI_read_mbox</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">GKI_read_mbox</span></span>&nbsp;function</li>
<li style="text-align: left;">Depending the&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">p_msg-&gt;event</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">p_msg-&gt;event</span></span><em>&nbsp;</em>value, the message is processed. If no case corresponds to the event, a global callbacks table is checked. If a callback for this event was found it is expected.</li>
<li style="text-align: left;">Loop</li>
</ol>
<p style="text-align: justify;"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(8).png" width="602" height="579"></p>
<p style="text-align: left;">The exploitation needs two writes :</p>
<ul style="text-align: justify;">
<li style="text-align: left;">A first one to register a new callback. This write is also used to register the corresponding message in the mailbox.</li>
<li style="text-align: left;">A second one to modify the mbox address and make it point to the previous registered message during the first write.<strong style="font-family: Montserrat, &#39;Helvetica Neue&#39;, sans-serif; font-size: 19px; letter-spacing: 0.13333em; text-align: justify; text-transform: uppercase;">&nbsp;</strong></li>
</ul>
<h3 style="text-align: justify;"><strong>First write : Register a new callback and prepare a new mailbox message</strong></h3>
<p style="text-align: left;">Callback list is stored in the global&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">btu_cb</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">btu_cb</span></span>&nbsp;structure which is described below.<br>
The field&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">event_reg</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">event_reg</span></span>&nbsp;contains callbacks associated to an event value.</p>
<p style="text-align: justify;"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(9).png" width="602" height="332"></p>
<p style="text-align: left;">A good point is that&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">event_reg</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">event_reg</span></span>&nbsp;is located at the begin of the structure. Previous data will be used to register the next new message in the mailbox.</p>
<p style="text-align: left;">A first arbitrary write is performed to register the <code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">system</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">system</span></span> callback associated to event 0xBE, this new event ID will be used to call the final stage of the exploit (calling libc‚Äôs system function).</p>
<p style="text-align: left;"><strong><br>
</strong><strong>Second write : Modify the mailbox pointer</strong></p>
<p style="text-align: left;">Mailing boxes are stored in the&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">gki_cb</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">gki_cb</span></span>&nbsp;global variable in the&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">OSTaskQFrist[]</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">OSTaskQFrist</span><span class="br0">[</span><span class="br0">]</span></span><code>&nbsp;</code>field.<br>
A mailbox is simply a chained list of&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">BUFFER_HDR_T</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">BUFFER_HDR_T</span></span>&nbsp;elements already described in the previous part.</p>
<p style="font-weight: 400; text-align: left;">By changing the pointer of&nbsp;<code class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">BTU_HCI_RCV_MBOX</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">BTU_HCI_RCV_MBOX</span></span>&nbsp;mailbox queue with the address of the last arbitrary write, the new message will be processed and controlled callback will be executed.</p>
<p style="text-align: justify;"><strong>Following diagram sums up the two writes :</strong></p>
<p style="text-align: justify;"><a href="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(10).png"><img class=" aligncenter" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/pasted image 0(10).png" width="640" height="442" border="0"></a></p>
<p style="text-align: left;">Note that arguments in green cannot contain null characters and unused fields are set to 0x1111.</p>
<h2>Post Exploitation</h2>
<p style="text-align: left;">Using the exploitation explained above it is now possible to execute shell commands with the privileges of&nbsp;<em>com.android.bluetooth.</em></p>
<p style="text-align: left;">Unlike the demo done by Armis, we cannot use&nbsp;<em>netcat</em>&nbsp;tool to upload content of the phone. However old android versions contain&nbsp;<em>adb&nbsp;</em>tool<em>.</em></p>
<p style="text-align: left;">A linux version of&nbsp;<em>adbd</em>&nbsp;has been modified and was started as a server on computer side.</p>
<p style="text-align: left;">Then it is possible from the nexus 4 to connect to this server&nbsp;<em>adb connect .</em></p>
<p style="text-align: left;">Data can be uploaded using for instance&nbsp;<em>adb push /sdcard/ </em></p>
<p style="text-align: left;"><strong>Python exploitation script :</strong></p>
<p style="text-align: left;"><a href="https://gist.github.com/sploit3r/4161b6f71e595433543e10f97de2098e">https://gist.github.com/sploit3r/4161b6f71e595433543e10f97de2098e</a></p>
<p style="font-weight: 400;"><strong><br>
</strong><strong>Modified adbd daemon + patch :&nbsp;</strong></p>
<p style="font-weight: 400; text-align: justify;"><a href="https://github.com/robclark/core">https://github.com/robclark/core<br>
</a><a href="https://gist.github.com/sploit3r/19b56240eb0d7fb723a359c37059b180">https://gist.github.com/sploit3r/19b56240eb0d7fb723a359c37059b180</a></p>
<pre class="EnlighterJSRAW" data-enlighter-language="shell" style="display: none;">mkdir lib
adb pull /system/lib/libc.so ./lib
adb pull /system/lib/hw/bluetooth.default.so ./lib
sudo python2 exploit.py hci0 AA:BB:CC:DD:EE:FF ./lib/</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">mkdir lib</span></li><li class=" even"><span class="">adb pull /system/lib/libc.so ./lib</span></li><li class=" odd"><span class="">adb pull /system/lib/hw/bluetooth.default.so ./lib</span></li><li class=" even"><span class="">sudo python2 exploit.py hci0 AA:BB:CC:DD:EE:FF ./lib/</span></li></ol><pre style="display: none;">mkdir lib
adb pull /system/lib/libc.so ./lib
adb pull /system/lib/hw/bluetooth.default.so ./lib
sudo python2 exploit.py hci0 AA:BB:CC:DD:EE:FF ./lib/</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<h2 style="text-align: justify;">Thanks</h2>
<p>Thanks to David, Guillaume and Max for their feedback <img draggable="false" class="emoji" alt="üòâ" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/1f609.svg"></p>
	</div><!-- .entry-content -->

	<footer class="entry-footer clearfix"><span class="cat-tags-links"><span class="cat-links"><span class="cat-icon"><i class="fa fa-folder-open"></i></span><span class="screen-reader-text">Categories</span><a href="http://sploit3r.xyz/category/android/" rel="category tag">Android</a></span><span class="tags-links"><span class="tags-icon"><i class="fa fa-hashtag" aria-hidden="true"></i></span><span class="screen-reader-text">Tags</span><a href="http://sploit3r.xyz/tag/android/" rel="tag">Android</a>, <a href="http://sploit3r.xyz/tag/blueborne/" rel="tag">Blueborne</a>, <a href="http://sploit3r.xyz/tag/bluetooth/" rel="tag">Bluetooth</a>, <a href="http://sploit3r.xyz/tag/exploit/" rel="tag">Exploit</a></span></span></footer></article>

	<nav class="navigation post-navigation" role="navigation">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-next"><a href="http://sploit3r.xyz/cve-2017-13284-injection-in-configuration-file/" rel="next"><span class="meta-nav" aria-hidden="true">Next</span><span class="screen-reader-text">Next post:</span> <span class="post-title">CVE-2017-13284 : Injection in configuration file</span></a></div></div>
	</nav>
<div id="comments" class="comments-area">

			<h3 class="comments-title">
			8 Replies to ‚ÄúBlueBorne exploitation on Nexus 4‚Äù		</h3>

		
		<ol class="comment-list">
					<li id="comment-6" class="comment even thread-even depth-1 parent">
			<article id="div-comment-6" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt="" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/5213d39c9b763cace24e5bc8df98a848.png" srcset="http://2.gravatar.com/avatar/5213d39c9b763cace24e5bc8df98a848?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42">						<b class="fn">magno</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/#comment-6">
							<time datetime="2018-05-04T08:48:42+00:00">
								May 4, 2018 at 8:48 am							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>hi, ‚Äúmdkir lib‚Äù bad!</p>
<p>      ‚Äúmkdir lib‚Äù god!</p>
				</div><!-- .comment-content -->

				<div class="reply"><a rel="nofollow" class="comment-reply-link" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/?replytocom=6#respond" onclick="return addComment.moveForm( &quot;div-comment-6&quot;, &quot;6&quot;, &quot;respond&quot;, &quot;4&quot; )" aria-label="Reply to magno">Reply</a></div>			</article><!-- .comment-body -->
<ol class="children">
		<li id="comment-8" class="comment byuser comment-author-sploit3r bypostauthor odd alt depth-2">
			<article id="div-comment-8" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt="" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/1adedaa074a723757519140021e4a7e9.png" srcset="http://1.gravatar.com/avatar/1adedaa074a723757519140021e4a7e9?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42">						<b class="fn">sploit3r</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/#comment-8">
							<time datetime="2018-05-04T10:39:03+00:00">
								May 4, 2018 at 10:39 am							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>Thanks <img draggable="false" class="emoji" alt="üôÇ" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/1f642.svg"></p>
				</div><!-- .comment-content -->

				<div class="reply"><a rel="nofollow" class="comment-reply-link" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/?replytocom=8#respond" onclick="return addComment.moveForm( &quot;div-comment-8&quot;, &quot;8&quot;, &quot;respond&quot;, &quot;4&quot; )" aria-label="Reply to sploit3r">Reply</a></div>			</article><!-- .comment-body -->
</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li id="comment-9" class="comment even thread-odd thread-alt depth-1 parent">
			<article id="div-comment-9" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt="" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/5213d39c9b763cace24e5bc8df98a848.png" srcset="http://2.gravatar.com/avatar/5213d39c9b763cace24e5bc8df98a848?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42">						<b class="fn">magno</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/#comment-9">
							<time datetime="2018-05-09T11:38:25+00:00">
								May 9, 2018 at 11:38 am							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>I follow the steps, but I have failed.</p>
<p>‚Äú<br>
‚ñò] Exploit: Sending packet 0<br>
[ERROR] Invalid continuation state received.<br>
Traceback (most recent call last):<br>
  File ‚Äúexp.py‚Äù, line 261, in<br>
    main(*sys.argv[1:])<br>
  File ‚Äúexp.py‚Äù, line 258, in main<br>
    exploit.run()<br>
  File ‚Äúexp.py‚Äù, line 247, in run<br>
    libc_text_base, bluetooth_default_bss_base = memory_leak_get_bases(self.src_hci, self.dst)<br>
  File ‚Äúexp.py‚Äù, line 65, in memory_leak_get_bases<br>
    log.error(‚ÄòInvalid continuation state received.‚Äô)<br>
  File ‚Äú/usr/local/lib/python2.7/dist-packages/pwnlib/log.py‚Äù, line 417, in error<br>
    raise PwnlibException(message % args)<br>
pwnlib.exception.PwnlibException: Invalid continuation state received.<br>
‚Äù</p>
				</div><!-- .comment-content -->

				<div class="reply"><a rel="nofollow" class="comment-reply-link" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/?replytocom=9#respond" onclick="return addComment.moveForm( &quot;div-comment-9&quot;, &quot;9&quot;, &quot;respond&quot;, &quot;4&quot; )" aria-label="Reply to magno">Reply</a></div>			</article><!-- .comment-body -->
<ol class="children">
		<li id="comment-10" class="comment byuser comment-author-sploit3r bypostauthor odd alt depth-2 parent">
			<article id="div-comment-10" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt="" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/1adedaa074a723757519140021e4a7e9.png" srcset="http://1.gravatar.com/avatar/1adedaa074a723757519140021e4a7e9?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42">						<b class="fn">sploit3r</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/#comment-10">
							<time datetime="2018-05-10T08:25:40+00:00">
								May 10, 2018 at 8:25 am							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>Hi,<br>
It seems the memory leak (CVE-2017-0785) does not work.<br>
What is the android version on your Nexus 4 ?<br>
You can test memory leak with this script <a href="https://github.com/ojasookert/CVE-2017-0785/blob/master/CVE-2017-0785.py" rel="nofollow">https://github.com/ojasookert/CVE-2017-0785/blob/master/CVE-2017-0785.py</a></p>
				</div><!-- .comment-content -->

				<div class="reply"><a rel="nofollow" class="comment-reply-link" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/?replytocom=10#respond" onclick="return addComment.moveForm( &quot;div-comment-10&quot;, &quot;10&quot;, &quot;respond&quot;, &quot;4&quot; )" aria-label="Reply to sploit3r">Reply</a></div>			</article><!-- .comment-body -->
<ol class="children">
		<li id="comment-12" class="comment even depth-3">
			<article id="div-comment-12" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt="" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/5213d39c9b763cace24e5bc8df98a848.png" srcset="http://2.gravatar.com/avatar/5213d39c9b763cace24e5bc8df98a848?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42">						<b class="fn">magno</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/#comment-12">
							<time datetime="2018-05-10T12:11:19+00:00">
								May 10, 2018 at 12:11 pm							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>Android 5.1.1 Not Nexus 4</p>
<p>Open ‚ÄúCVE-2017-0785.py‚Äù</p>
<p>The same mistake :</p>
<p>‚Äú[O] Exploit: Sending packet 0<br>
[ERROR] Invalid continuation state received.<br>
Traceback (most recent call last):<br>
File ‚Äúcve1.py‚Äù, line 38, in<br>
log.error(‚ÄòInvalid continuation state received.‚Äô)<br>
File ‚Äú/usr/local/lib/python2.7/dist-packages/pwnlib/log.py‚Äù, line 417, in error<br>
raise PwnlibException(message % args)<br>
pwnlib.exception.PwnlibException: Invalid continuation state received.<br>
‚Äù</p>
				</div><!-- .comment-content -->

				<div class="reply"><a rel="nofollow" class="comment-reply-link" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/?replytocom=12#respond" onclick="return addComment.moveForm( &quot;div-comment-12&quot;, &quot;12&quot;, &quot;respond&quot;, &quot;4&quot; )" aria-label="Reply to magno">Reply</a></div>			</article><!-- .comment-body -->
</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li id="comment-11" class="comment odd alt thread-even depth-1">
			<article id="div-comment-11" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt="" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/5213d39c9b763cace24e5bc8df98a848.png" srcset="http://2.gravatar.com/avatar/5213d39c9b763cace24e5bc8df98a848?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42">						<b class="fn">magno</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/#comment-11">
							<time datetime="2018-05-10T12:10:55+00:00">
								May 10, 2018 at 12:10 pm							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>Android 5.1.1 Not Nexus 4</p>
<p>Open ‚ÄúCVE-2017-0785.py‚Äù</p>
<p>The same mistake :</p>
<p>‚Äú[O] Exploit: Sending packet 0<br>
[ERROR] Invalid continuation state received.<br>
Traceback (most recent call last):<br>
  File ‚Äúcve1.py‚Äù, line 38, in<br>
    log.error(‚ÄòInvalid continuation state received.‚Äô)<br>
  File ‚Äú/usr/local/lib/python2.7/dist-packages/pwnlib/log.py‚Äù, line 417, in error<br>
    raise PwnlibException(message % args)<br>
pwnlib.exception.PwnlibException: Invalid continuation state received.<br>
‚Äù</p>
				</div><!-- .comment-content -->

				<div class="reply"><a rel="nofollow" class="comment-reply-link" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/?replytocom=11#respond" onclick="return addComment.moveForm( &quot;div-comment-11&quot;, &quot;11&quot;, &quot;respond&quot;, &quot;4&quot; )" aria-label="Reply to magno">Reply</a></div>			</article><!-- .comment-body -->
</li><!-- #comment-## -->
		<li id="comment-14" class="comment even thread-odd thread-alt depth-1 parent">
			<article id="div-comment-14" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt="" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/bc923374b6cf7583253817ac8a4fdfbe.png" srcset="http://2.gravatar.com/avatar/bc923374b6cf7583253817ac8a4fdfbe?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42">						<b class="fn">Tzxiang</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/#comment-14">
							<time datetime="2018-06-05T11:17:37+00:00">
								June 5, 2018 at 11:17 am							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>Any idea how to do the post exploit of waking up the phone and mounting uhid?</p>
				</div><!-- .comment-content -->

				<div class="reply"><a rel="nofollow" class="comment-reply-link" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/?replytocom=14#respond" onclick="return addComment.moveForm( &quot;div-comment-14&quot;, &quot;14&quot;, &quot;respond&quot;, &quot;4&quot; )" aria-label="Reply to Tzxiang">Reply</a></div>			</article><!-- .comment-body -->
<ol class="children">
		<li id="comment-15" class="comment odd alt depth-2">
			<article id="div-comment-15" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt="" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/8679832fb09b9f416a86344aed1033be.png" srcset="http://2.gravatar.com/avatar/8679832fb09b9f416a86344aed1033be?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42">						<b class="fn">3lectron</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/#comment-15">
							<time datetime="2018-06-19T08:54:54+00:00">
								June 19, 2018 at 8:54 am							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>@Tzxiang: Were you able to get this to execute properly? </p>
<p>Working with a LG G3, stock ROM android 5.0.1‚Ä¶ Same Bluetooth sources.</p>
<p>Script runs without errors and verified that the payloads land in memory at the correct positions relative to their intended structures (remote debug w/ IDA Pro), but for some reason it does nothing more than jam up bluetooth and requires manual reset during which the slider button flips on/off by itself a few times over 30 secs or so. This only happens on the second iteration of the OSTaskQFirst overwrite, which if I‚Äôm sane (?) should be the trigger packet. Seems as though beyond having the data written, something does indeed happen where program flow is altered and then goes back to idle loop, but no longer responds to connections until reset. I have made various adjustments to payload offsets in testing, but none have any effect other than outright crashing bluetooth. IDA is a pain and does not like breakpoints for some reason on this one, even after blanketing the related asm functions, they‚Äôre ignored and I never get to trace execution. I am not very familiar with gdb‚Ä¶ but can follow and learn if anyone has some tips there.</p>
<p>Also, any idea where the magic header ‚Äú‚Ä¶00 00010000 00410000 ‚Ä¶.‚Äù is generated along the way in the sources and why debugging live memory shows one less 0 between 0x41 byte and start of payload than as written in script? Trying to understand its relevance.</p>
<p>Anyone have any clues on these?</p>
				</div><!-- .comment-content -->

				<div class="reply"><a rel="nofollow" class="comment-reply-link" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/?replytocom=15#respond" onclick="return addComment.moveForm( &quot;div-comment-15&quot;, &quot;15&quot;, &quot;respond&quot;, &quot;4&quot; )" aria-label="Reply to 3lectron">Reply</a></div>			</article><!-- .comment-body -->
</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		
	
	
		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/#respond" style="display:none;">Cancel reply</a></small></h3>			<form action="http://sploit3r.xyz/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate="">
				<p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" required="required"></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" required="required"></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200"></p>
<p class="comment-form-cookies-consent"><input id="wp-comment-cookies-consent" name="wp-comment-cookies-consent" type="checkbox" value="yes"><label for="wp-comment-cookies-consent">Save my name, email, and website in this browser for the next time I comment.</label></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment"> <input type="hidden" name="comment_post_ID" value="4" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">
</p>			</form>
			</div><!-- #respond -->
	
</div><!-- .comments-area -->
		</main><!-- .site-main -->
		
<aside id="secondary" class="sidebar widget-area col-md-4 col-sm-12" role="complementary">
	<section id="search-2" class="widget widget_search">
<form action="http://sploit3r.xyz/" method="get" role="search" id="searchform_topbar" class="search-top-bar-popup search-form">
	<label>
		<span class="screen-reader-text">Search for:</span>
		<input type="search" class="search-field-top-bar" id="search-field-top-bar" placeholder="Search ‚Ä¶" value="" name="s">
	</label>
	<button type="submit" class="search-submit search-top-bar-submit" id="search-top-bar-submit">
        <span class="fa fa-search header-search-icon"></span>
        <span class="screen-reader-text">
            Search        </span>
    </button>
</form>
</section><section id="pages-3" class="widget widget_pages"><h4 class="widget-title">Info</h4>		<ul>
			<li class="page_item page-item-24"><a href="http://sploit3r.xyz/about/">About</a></li>
		</ul>
		</section>		<section id="recent-posts-2" class="widget widget_recent_entries">		<h4 class="widget-title">Recent Posts</h4>		<ul>
											<li>
					<a href="http://sploit3r.xyz/cve-2017-13284-injection-in-configuration-file/">CVE-2017-13284 : Injection in configuration file</a>
									</li>
											<li>
					<a href="http://sploit3r.xyz/blueborne-exploitation-nexus-4/">BlueBorne exploitation on Nexus 4</a>
									</li>
					</ul>
		</section><section id="archives-2" class="widget widget_archive"><h4 class="widget-title">Archives</h4>		<ul>
			<li><a href="http://sploit3r.xyz/2018/05/">May 2018</a></li>
	<li><a href="http://sploit3r.xyz/2018/02/">February 2018</a></li>
		</ul>
		</section><section id="categories-2" class="widget widget_categories"><h4 class="widget-title">Categories</h4>		<ul>
	<li class="cat-item cat-item-2"><a href="http://sploit3r.xyz/category/android/">Android</a>
</li>
		</ul>
</section></aside><!-- .sidebar .widget-area -->
	</div><!-- content-area -->

        </div><!-- .site-content -->

        <footer id="colophon" class="site-footer" role="contentinfo">
            <div class="site-info container">
                            <a href="https://wordpress.org/">Proudly powered by WordPress</a>

                                <a class="theme-credit" href="https://abdulrafay.me/" target="_blank">Simplent Theme by Rafay</a>
            </div>
        </footer>

    </div><!-- site-inner -->
</div><!-- site -->

<script type="text/javascript">
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"http:\/\/sploit3r.xyz\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}}};
/* ]]> */
</script>
<script type="text/javascript" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/scripts.js.download"></script>
<script type="text/javascript" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/skip-link-focus-fix.js.download"></script>
<script type="text/javascript" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/bootstrap.min.js.download"></script>
<script type="text/javascript" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/comment-reply.min.js.download"></script>
<script type="text/javascript">
/* <![CDATA[ */
var simplent_screenReaderText = {"expand":"expand child menu","collapse":"collapse child menu"};
/* ]]> */
</script>
<script type="text/javascript" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/main.js.download"></script>
<script type="text/javascript" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/mootools-core-yc.js.download"></script>
<script type="text/javascript" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/EnlighterJS.min.js.download"></script>
<script type="text/javascript" src="./BlueBorne exploitation on Nexus 4 ‚Äì Sploit3r_files/wp-embed.min.js.download"></script>
<script type="text/javascript">/* <![CDATA[ */EnlighterJS_Config = {"selector":{"block":"pre.EnlighterJSRAW","inline":"code.EnlighterJSRAW"},"language":"generic","theme":"enlighter","indent":2,"hover":"hoverEnabled","showLinenumbers":true,"rawButton":true,"infoButton":true,"windowButton":true,"rawcodeDoubleclick":false,"grouping":true,"cryptex":{"enabled":false,"email":"mail@example.tld"}};!function(){var a=function(a){var b="Enlighter Error: ";console.error?console.error(b+a):console.log&&console.log(b+a)};return window.addEvent?"undefined"==typeof EnlighterJS?void a("Javascript Resources not loaded yet!"):"undefined"==typeof EnlighterJS_Config?void a("Configuration not loaded yet!"):void window.addEvent("domready",function(){EnlighterJS.Util.Init(EnlighterJS_Config.selector.block,EnlighterJS_Config.selector.inline,EnlighterJS_Config)}):void a("MooTools Framework not loaded yet!")}();;/* ]]> */</script>
</body></html>